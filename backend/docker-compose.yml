services:
  init-secrets:
    image: alpine:3.21
    container_name: yuiroom-init-secrets
    restart: "no"
    volumes:
      - ./secrets:/secrets
    command: >
      sh -euxc '
        apk add --no-cache openssl >/dev/null;
        umask 077;
        if [ ! -s /secrets/postgres_password ]; then
          openssl rand -base64 36 | tr -d "\n" > /secrets/postgres_password;
        fi
        if [ ! -s /secrets/auth_secret ]; then
          openssl rand -hex 48 | tr -d "\n" > /secrets/auth_secret;
        fi
        pw="$(cat /secrets/postgres_password)";
        echo "postgres://yuiroom:${pw}@postgres:5432/yuiroom" > /secrets/database_url;
        chmod 0644 /secrets/postgres_password /secrets/auth_secret /secrets/database_url;
      '

  postgres:
    image: postgres:18.1
    container_name: yuiroom-postgres
    restart: unless-stopped
    depends_on:
      init-secrets:
        condition: service_completed_successfully
    environment:
      POSTGRES_USER: yuiroom
      POSTGRES_DB: yuiroom
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./secrets:/run/secrets:ro

volumes:
  pgdata:
