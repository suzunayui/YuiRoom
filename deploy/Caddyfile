yuiroom.net {
  encode zstd gzip

  # Security headers (for the frontend + API responses passing through here)
  header {
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    Referrer-Policy "no-referrer"
    X-Frame-Options "DENY"
    Permissions-Policy "camera=(), microphone=(), geolocation=()"
    Content-Security-Policy "default-src 'self'; base-uri 'none'; object-src 'none'; frame-ancestors 'none'; form-action 'self'; connect-src 'self' ws: wss:; img-src 'self' blob: data:; media-src 'self' blob:; style-src 'self' 'unsafe-inline'; script-src 'self'"
  }

  # Ensure routing order (WebSocket/API must bypass SPA fallback).
  route {
    # Backend API (strip /api)
    handle_path /api/* {
      reverse_proxy backend:3000
    }

    # WebSocket
    handle /ws* {
      reverse_proxy backend:3000
    }

    # Frontend (Vite build output) + SPA fallback
    handle {
      root * /var/www/yuiroom/renderer/dist
      try_files {path} /index.html
      file_server
    }
  }
}
