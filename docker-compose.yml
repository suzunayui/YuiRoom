services:
  init-secrets:
    image: alpine:3.21
    container_name: yuiroom-init-secrets
    restart: "no"
    volumes:
      - ./secrets:/secrets
    command: >
      sh -euxc '
        apk add --no-cache openssl >/dev/null;
        umask 077;
        if [ ! -s /secrets/postgres_password ]; then
          openssl rand -base64 36 | tr -d "\n" > /secrets/postgres_password;
        fi
        if [ ! -s /secrets/auth_secret ]; then
          openssl rand -hex 48 | tr -d "\n" > /secrets/auth_secret;
        fi
        pw="$(cat /secrets/postgres_password)";
        echo "postgres://yuiroom:${pw}@postgres:5432/yuiroom" > /secrets/database_url;
        # Make sure containers can read these files even when not running as root.
        chmod 0644 /secrets/postgres_password /secrets/auth_secret /secrets/database_url;
      '

  postgres:
    image: postgres:18.1
    container_name: yuiroom-postgres
    restart: unless-stopped
    depends_on:
      init-secrets:
        condition: service_completed_successfully
    environment:
      POSTGRES_USER: yuiroom
      POSTGRES_DB: yuiroom
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
    volumes:
      # Postgres 18+ expects a single mount at /var/lib/postgresql (it will create a versioned subdir).
      - pgdata:/var/lib/postgresql
      - ./secrets:/run/secrets:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U yuiroom"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 20s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: yuiroom-backend
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: "3000"
      DATABASE_URL_FILE: /run/secrets/database_url
      AUTH_SECRET_FILE: /run/secrets/auth_secret
      CORS_ORIGIN: https://yuiroom.net
      WS_ORIGIN: https://yuiroom.net
      RP_ID: yuiroom.net
      RP_ORIGIN: https://yuiroom.net
      RP_NAME: YuiRoom
    volumes:
      - ./secrets:/run/secrets:ro

  caddy:
    build:
      context: .
      dockerfile: deploy/caddy/Dockerfile
      args:
        VITE_API_BASE: /api
    container_name: yuiroom-caddy
    restart: unless-stopped
    depends_on:
      - backend
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - caddy_data:/data
      - caddy_config:/config

volumes:
  pgdata:
  caddy_data:
  caddy_config:
